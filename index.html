<!-- index.html to test what markup would look like locally (independent of target) -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Q Tool</title>
    <meta name="description" content="">
    <script src="https://rawgit.com/filamentgroup/loadCSS/master/src/loadCSS.js"></script> 
    <script src="https://q-server.st.nzz.ch/files/system.js"></script>
  </head>
  <body>
    <div id="container">
      <select id="fixtures-select" class="s-input-select" style="margin-bottom: 20px;"></select>
      <div id="q-tool"></div>
    </div>
    <script> 
      // load fixture data and populate select element with titles
      fetch('http://localhost:3001/tools/fixtures/data')
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error(response);
        })
        .then(fixtureData => {
          let selectElement = document.getElementById('fixtures-select');
          fixtureData.forEach((data, index) => {
            let option = document.createElement('option');
            // removes mandatory 'FIXTURE: ' from title
            option.text = data.title.substr(9);
            option.value = index;
            selectElement.appendChild(option);
          });
          // init with rendering info for first item in select
          updateRenderingInfoForItem(fixtureData, 0);

          // as soon as another fixture data item is selected, update with its rendering info
          selectElement.addEventListener('change', () => {
            updateRenderingInfoForItem(fixtureData, selectElement.selectedIndex);
          })
        });

      
      function loadAllScripts(scripts, index, callback) {
        if (scripts[index] && scripts[index].url) {
          loadJS(scripts[index].url, () => {
            loadAllScripts(scripts, index + 1, callback)
          })
        } else {
          callback();
        }
      }

      function loadRenderingInfo(fixtureData, index) {
        // currently available targets - can be switched manually if needed
        const target = 'nzz_ch'
        // const target = 'nzzas'
        
        return fetch(`http://localhost:3001/rendering-info/${index}/${target}`)
          .then(response => {
            if (response.ok) {
              return response.json();
            } 
            throw new Error(response);
          })
          .catch(e => {
            console.log(e);
            // do nothing
          });
      }

      function updateRenderingInfoForItem(fixtureData, index) {
        loadRenderingInfo(fixtureData, index)
          .then(data => {
            // load background color if configured
            if (data.background) {
              document.getElementById('container').style.background = data.background.color;
            }

            // load stylesheets from tool
            if (data.stylesheets) {
              data.stylesheets.forEach(stylesheet => {
                if (stylesheet.name) {
                  stylesheet.url = `http://localhost:3001/tools/stylesheet/${stylesheet.name}`
                }
                loadCSS(stylesheet.url)
              })
            }
            
            // add markup
            document.getElementById('q-tool').innerHTML = data.markup;

            // load scripts from tool
            if (!data.scripts) {
              return;
            }
            data.scripts = data.scripts
              .map(script => {
                if (script.name) {
                  script.url = `http://localhost:3001/tools/script/${script.name}`
                }
                return script;
              })
            let urlScripts = data.scripts
              .filter(script => script.url)
            let contentScripts = data.scripts
              .filter(script => script.content)
            loadAllScripts(urlScripts, 0, () => {
              contentScripts.forEach(script => {
                let scriptElement = document.createElement('script');
                scriptElement.innerHTML = script.content;
                document.getElementById('q-tool').appendChild(scriptElement);
              })
            })
          })
      }
    </script>
  </body>
</html>
