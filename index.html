<!-- index.html to test what markup would look like locally (independent of target) -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Q Tool</title>
    <meta name="description" content="">
    <script src="https://rawgit.com/filamentgroup/loadCSS/master/src/loadCSS.js"></script> 
    <script type="text/javascript" src="assets-definition.js"></script>
    <script src="https://q-server.st.nzz.ch/files/system.js"></script>
  </head>
  <body>
    <div id="container">
      <select id="fixtures-select" class="s-input-select" style="margin-bottom: 20px;"></select>
      <div id="q-tool"></div>
    </div>
    <script> 
      fetch('http://localhost:3000/fixtures/data')
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error(response);
        })
        .then(fixtureData => {
          let selectElement = document.getElementById('fixtures-select');
          fixtureData.forEach((data, index) => {
            let option = document.createElement('option');
            // removes mandatory 'FIXTURE: ' from title
            option.text = data.title.substr(9);
            option.value = index;
            selectElement.appendChild(option);
          });
          updateFixtureData(fixtureData, 0);
          selectElement.addEventListener('change', () => {
            updateFixtureData(fixtureData, selectElement.selectedIndex);
          })
        });

      function loadAllScripts(scripts, index, callback) {
        if (scripts[index] && scripts[index].url) {
          loadJS(scripts[index].url, () => {
            loadAllScripts(scripts, index + 1, callback)
          })
        } else {
          callback();
        }
      }

      // load sophie modules - change modules according to your needs in assets-definition.js -> sophie
      function loadSophieModules() {
        if (assets.sophie && assets.sophie.length > 0) {
          let sophieUrl = 'https://service.sophie.nzz.ch/bundle/';
          assets.sophie.forEach((moduleName, index) => {
            sophieUrl += moduleName;
            if (index < assets.sophie.length - 1) {
              sophieUrl += ',';
            }
          })
          sophieUrl += '.css';
          loadCSS(sophieUrl);
        }
      }

      // load context, e.g. nzz.ch assets, change url according to your needs in assets-definition.js -> context
      function loadContext() {
        if (assets.context && assets.context.length > 0) {
          assets.context.forEach(url => {
            loadCSS(url);
          })
        }
      }

      function loadRenderingInfo(fixtureData, index) {
        const pathEnds = ['html-static', 'html-js', 'web'];
        let promises = [];

        pathEnds.forEach(pathEnd => {
          promises.push(
            fetch(`http://localhost:3000/rendering-info/${pathEnd}`, {
              method: 'POST',
              body: JSON.stringify({
                item: fixtureData[index],
                toolRuntimeConfig: {
                  toolBaseUrl: 'http://localhost:3000'
                }
              }),
              headers: {
                'Content-Type': 'application/json'
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              } 
              throw new Error(response);
            })
            .catch(e => {
              console.log(e);
              // do nothing
            })
          )
        })
        return Promise.all(promises);
      }

      function updateFixtureData(fixtureData, index) {
        loadRenderingInfo(fixtureData, index)
          .then(responses => {
            let renderingInfos = responses.filter(response => {
              return response !== undefined;
            })
            if (renderingInfos.length > 0) {
              return renderingInfos[0];
            }
            throw new Error('no rendering info available');
          })
          .then(data => {
            loadSophieModules();
            loadContext();

            // load stylesheets from tool
            if (data.stylesheets) {
              data.stylesheets.forEach(stylesheet => {
                if (stylesheet.name) {
                  stylesheet.url = `http://localhost:3000/stylesheet/${stylesheet.name}`
                }
                loadCSS(stylesheet.url)
              })
            }
            
            document.getElementById('q-tool').innerHTML = data.markup;

            // load scripts from tool
            if (!data.scripts) {
              return;
            }
            data.scripts = data.scripts
              .map(script => {
                if (script.name) {
                  script.url = `http://${window.location.hostname}:3000/script/${script.name}`
                }
                return script;
              })
            let urlScripts = data.scripts
              .filter(script => script.url)
            let contentScripts = data.scripts
              .filter(script => script.content)
            loadAllScripts(urlScripts, 0, () => {
              contentScripts.forEach(script => {
                let scriptElement = document.createElement('script');
                scriptElement.innerHTML = script.content;
                document.getElementById('q-tool').appendChild(scriptElement);
              })
            })
          })
      }
    </script>
  </body>
</html>
