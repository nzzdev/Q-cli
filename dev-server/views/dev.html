<!-- index.html to test what markup would look like locally (independent of target) -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Q Tool</title>
    <meta name="viewport" content="width=device-width">
    <script src="https://cdn.jsdelivr.net/gh/muicss/loadjs@3.6.1/dist/loadjs.min.js"></script>
    <script src="https://q-server.st.nzz.ch/files/system.js"></script>
    <!-- if context is given load stylesheets and scripts if available -->
    {%- if context.stylesheets %}
      {%- for stylesheet in context.stylesheets %}
        {%- if stylesheet.url %}
          <link rel="stylesheet" href="{{ stylesheet.url }}">
        {%- endif %}
        {%- if stylesheet.content %}
          <style>
            {{ stylesheet.content }}
          </style>
        {%- endif %}
      {%- endfor %}
    {%- endif %}
    {%- if context.scripts %}
      {%- for script in context.scripts %}
        {%- if script.url %}
          <script src="{{ script.url }}"></script>
        {%- endif %}
        {%- if script.content %}
          <script>
            {{ script.content }}
          </script>
        {%- endif %}
      {%- endfor %}
    {%- endif %}
    <style>
      body {
        padding: 0;
        margin: 0;
        {%- if context.background %}
        background-color: {{ context.background.color }};
        color: {{ context.background.color }}
        {%- endif %}
      }
      .fixtures__container {
        display: flex;
      }
      .fixtures__select {
        font-family: nzz-sans-serif,Helvetica,Arial;
        font-size: 13px;
        font-weight: 500;
        height: 30px;
        line-height: 30px;
        width: 100%;
        padding: 0px 10px;
        outline: none;
        border-radius: 0;
        border: 1px solid transparent;
        color: #fff;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: #13175f;
        background-position: calc(100% - 10px) 11px;
        background-repeat: no-repeat;
        background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTFweCIgaGVpZ2h0PSI3cHgiIHZpZXdCb3g9IjAgMCAxMSA3IiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPg0KICAgIDxnIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPg0KICAgICAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNjAyLCAtMTIyNikiIGZpbGw9IiNGRkYiPg0KICAgICAgICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDY4LCAxMjA3KSI+DQogICAgICAgICAgICAgICAgPHBvbHlnb24gcG9pbnRzPSIxMzUuMDU5IDE5IDEzNCAyMC4wNjQgMTM5LjA3NCAyNS4xMjEgMTQ0LjEyMSAyMC4wOTEgMTQzLjA2MyAxOS4wMjggMTM5LjA3NCAyMy4wMDQiPjwvcG9seWdvbj4NCiAgICAgICAgICAgIDwvZz4NCiAgICAgICAgPC9nPg0KICAgIDwvZz4NCjwvc3ZnPg==');
      }
      .fixtures__select:hover {
        background-color: #2c32bd
      }
      .fixtures__reload-button {
        font-size: 13px;
        font-family: nzz-sans-serif,Helvetica,Arial;
        font-weight: 500;
        display: flex;
        flex-flow: row nowrap;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        height: 30px;
        padding: 0 10px;
        color: #fff;
        background-color: #13175f;
        border-width: 0px;
        border-radius: 0px;
      }
    </style>
  </head>
  <body class="page page--reportage livingdocs--article">
    <div class="fixtures__container">
      <select class="fixtures__select"></select>
      <button class="fixtures__reload-button" type="button">reload</button>
    </div>
    <div class="l--main" id="l--main">
      <div class="l--holder">
        <div class="l--wrapper">
          <article class="content">
            <main class="content__main">
              <div class="widget widget--qembed regwalled">
                <div>
                  <div class="s-q-item" id="container"></div>
                </div>
              </div>
            </main>
          </article>
        </div>
      </div>
    </div>
    <script> 
      const port = {{ port }};
      const target = '{{ target }}';
      // load fixture data and populate select element with titles
      fetch(`http://localhost:${port}/tools/fixtures/data`)
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error(response);
        })
        .then(fixtureData => {
          let selectElement = document.querySelector(".fixtures__select");
          fixtureData.forEach((data, index) => {
            let option = document.createElement('option');
            // removes mandatory 'FIXTURE: ' from title
            option.text = data.title.substr(9);
            option.value = index;
            selectElement.appendChild(option);
          });
          // init with rendering info for first item in select
          updateRenderingInfoForItem(fixtureData, 0);

          // as soon as another fixture data item is selected, update with its rendering info
          selectElement.addEventListener('change', () => {
            updateRenderingInfoForItem(fixtureData, selectElement.selectedIndex);
          });

          document.querySelector(".fixtures__reload-button").addEventListener('click', () => {
            updateRenderingInfoForItem(fixtureData, selectElement.selectedIndex);
          })
        });

      function loadRenderingInfo(fixtureData, index) {        
        return fetch(`http://localhost:${port}/rendering-info/${index}/${target}`)
          .then(response => {
            if (response.ok) {
              return response.json();
            } 
            throw new Error(response);
          })
          .catch(e => {
            console.log(e);
            // do nothing
          });
      }

      function updateRenderingInfoForItem(fixtureData, index) {
        loadRenderingInfo(fixtureData, index)
          .then(data => {
            if(data) {
              // add markup
              document.querySelector("#container").innerHTML = data.markup;
              // load resources
              data.scripts.map(script => {
                if(script.name) {
                  script.url = `http://localhost:${port}/tools/script/${script.name}`;
                }
              });
              data.stylesheets.map(stylesheet => {
                if (stylesheet.name) {
                  stylesheet.url = `http://localhost:${port}/tools/stylesheet/${stylesheet.name}`
                }
              });

              const urlResources = [...data.scripts.filter(script => script.url).map(script => script.url), ...data.stylesheets.filter(stylesheet => stylesheet.url).map(stylesheet => stylesheet.url)];
              loadjs(urlResources, {
                success: () => {
                  for(const script of data.scripts.filter(script => script.content)) {
                    const scriptElement = document.createElement('script');
                    scriptElement.innerHTML = script.content;
                    document.querySelector("#container").appendChild(scriptElement);
                  }
                },
                before: (path, scriptElement) => {
                  document.querySelector("#container").appendChild(scriptElement);
                  /* return `false` to bypass default DOM insertion mechanism */
                  return false;
                }
              });
            } else {
              throw new Error("Something went wrong while loading the renderingInfo. There might be a problem in your tool");
            }
          })
      }
    </script>
  </body>
</html>
